<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="placeholder" style="display: none;">
        <h1>Uh oh...</h1>

        <p>Looks like it's going to take a while to get the result.</p>

        Meanwhile, you can choose <a href="http://abetterbrowser.org/">a better browser</a>.
    </div>
    <article style="display: none;">
        <header>
            <time>сегодня в 16:17</time>
            <h1>Так ли необходимо высшее образование системному администратору?</h1>
            <ul class="tags">
                <li class="profiled"><a href="#" title="Вы не подписаны на этот хаб">Яндекс API</a></li>
                <li class="profiled"><a href="#" title="Вы не подписаны на этот хаб">Maps API</a></li>
                <li><a href="#" title="Вы не подписаны на этот хаб">Блог компании Яндекс</a></li>
            </ul>
        </header>

        <section class="content"></section>

        <footer>
            <ul class="tags">
                <li><a href="#">api</a></li>
                <li><a href="#">дизайн</a></li>
                <li><a href="#">ymapsapi</a></li>
                <li><a href="#">яндекс.карты</a></li>
            </ul>
        </footer>

        <section class="comments"></section>
    </article>

    <script type="text/x-template" data-template="comment">
        <li>
            <header>
                <a href="#" class="avatar"><img src="http://habrahabr.ru/i/avatars/stub-user-small.gif" alt="{author}"></a>
                <span class="username"><a href="http://habrahabr.ru/users/{author}/">{author}</a></span>
                <time>{date}</time>
                <a href="#" class="permalink">#</a>
            </header>
            <section class="message">{message}</section>
        </li>
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/dictionary.js"></script>
    <script src="js/parser.js"></script>
    <script src="js/writer.js"></script>
    <script src="js/garry.js"></script>
    <script>
        $('.placeholder').show();

        $.get('habr.1500.html', function (data) {
            window.parser = new Parser($(data)),
            window.gArticles = new Garry().eat(parser.articles()),
            window.gComments = new Garry().eat(parser.comments()),
            window.writer = new Writer(parser.usernames(), gComments, gArticles);

            /* TODO get rid of ugly brackets */
            $('.content').html(writer.getArticleText({
                paragraphs: {perText: {min: 5, max: 10}},
                sentences: {perParagraph: {min: 1, max: 5}},
                words: {perSentence: {min: 3, max: 15}}
            }));    /* especially here ↓ */
            $('article').append(buildCommentSection(writer.getCommentTree({
                paragraphs: {perText: {min: 1, max: 3}},
                sentences: {perParagraph: {min: 1, max: 5}},
                words: {perSentence: {min: 3, max: 6}}
            })));

            $('.placeholder').hide();
            $('article').show();

            $('article > header > h1').text(writer.getArticleHeader());
        });

        function buildCommentSection(comments) {
            return $('.comments')
                       .append('<h1>Комментарии (' + comments.getNumber() + ')</h1>')
                       .append(buildCommentTree(comments, +new Date()));
        }

        function buildCommentTree(comments, initial_date) {
            return $('<ul>').append(comments.map(function(comment) {
                initial_date += getRandomIntegerInRange(1, 60) * 60 * 1000;
                comment.date = timestampTostring(initial_date);
                var $comment = $('[data-template="comment"]').render(comment),
                    $replies = buildCommentTree(comment.replies, initial_date);

                return $comment.append($replies);
            }));
        }

        $.fn.render = function (data) {
            var tpl = $(this).html(),
                i;

            for (i in data) if (data.hasOwnProperty(i)) {
                tpl = tpl.replace(new RegExp('{' + i + '}', 'g'), data[i]);
            }

            return $(tpl);
        };
    </script>
</body>
</html>